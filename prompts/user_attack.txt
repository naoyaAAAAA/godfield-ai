# user_attack.txt（改善・重複排除版）

このファイルは **phase="attack" 専用の戦略方針（B）** を記す。
絶対ルール（出力仕様・型強制・usable/MP条件・フェーズ制約・攻撃カード枚数制限・闇/特殊など）は **system_core.txt** に従うこと。
（出力フォーマットも system_core.txt の A-9 を厳守）

以下では「何を優先して選ぶか」の方針のみを補足する。

B-2. 回復カードに関して（改訂）
--------------------------------------------------
以下、HP、MPを回復できるカードを回復カード、と呼ぶ

● 回復カードの価値

- 「両替」があるため、即時回復カードは常に強い。
  - HP・MPが十分ある状況でも、後の両替の自由度を上げるために価値がある。
- 回復カードを長く抱えすぎると、相手に「買う」で取られるリスクがある。
  特に HP/MP を 15 以上回復できるカードは、取られると致命的になりやすい。
- **HPがほぼ満タンでも、MPやgoldが減っているなら、MP/gold回復カードは
  「減ってから使う」のではなく「先に伸ばしておく」目的で積極的に使ってよい。**

● 使いどきの目安（攻撃フェーズ）

1. 自分HP ≤ 10 のとき（即死圏）
   - このラインでは、**リーサル確定攻撃がある場合を除き、攻撃よりHP回復を最優先する。**
   - 回復カードが複数ある場合は、一番回復量の大きいカード1枚だけを使い、
     それでも危険ライン（HP15程度）まで届かないなら、両替も候補に入れる。

2. 自分HP 11〜20 のとき
   - 期待ダメージ 8 未満の攻撃しかない場合は、攻撃よりHP・MP回復を優先してよい。
   - HP・MP を 10 以上回復できるカードがあれば、**そのターンで使うことを強く検討する。**
   - 「回復を温存して小さい攻撃をする」より、「しっかり回復してからプランを立て直す」方を評価する。

3. 自分HP 21〜29 のとき（安全圏だが、抱えすぎゾーン）
   - このレンジでは、「いつか減ったときに使う」よりも、
     **早めに回復を切ってリソースを整える**方を一段優先する。
   - 特に、HP/MP 合計で 15 以上回復できるカードや、
     単体で HP/MP を 10 以上伸ばせるカードは、
     相手の圧が弱いターンにどんどん使ってよい。
   - 例外は、
     - そのターンに明らかなリーサルがある場合
     だけ。

4. 自分HP ≥ 30 のとき（ほぼ満タン）
   - 回復カードを「後でまとめて使う」前提にせず、**早めに使ってHP・MPを上げきってしまってよい。**
   - これは、後の両替の選択肢を増やし、「買う」で奪われるリスクを減らすためでもある。
   - ただし、そのターンに明らかなリーサルがある場合は攻撃を優先してよい。

● 禁止事項・避けるべきパターン

- 強力な回復を、終盤まで抱えたまま何もせず負けることは避ける。
  - 「このターン使わないと、次のターンに買うで奪われたり、その前に死ぬ可能性が高い」
    と判断される場合は、多少オーバーヒールでも使う。
- **usable な回復があるのに、理由なく attack-pass を選ぶことはしない。**
  常に、手札に回復があれば、attack-passよりも優先して使うこと。

--------------------------------------------------
B-3. 両替に関して（簡易版・改訂）
--------------------------------------------------

※ 詳細な数値判断はAセクション（HPライン）と組み合わせて行う。
※ 本節は戦略方針（B）であり、Aの絶対ルールに反してはならない。

● 両替を「積極的に検討してよい」条件（攻撃フェーズ）

次のようなとき、「攻撃よりも強い選択肢」として両替を候補に入れる：

1. 今ターン、明らかに強い攻撃がない
   - 期待ダメージが 8 未満の攻撃しかない。
   - 当てても相手HPがまだ 25 以上など、全く苦しくならない。

2. 両替後の HP が十分に安全
   - 両替後 HP が少なくとも 15 以上になる案があること。
   - HP が 11 未満になるような両替案は、
     よほどの理由（奇跡連打でほぼ勝ちなど）がない限り選ばない。

3. 手札に「今後活かしたいカード」がある
   - MPが足りず撃てていない強力な奇跡（滝・天国風・天国病など）がある。
   - 「売る」を高価格で通したい / 「買う」を近いターンで使うなど、
     MPやgoldの配分次第で強さが変わるカードがある。
   - 財宝など、HPが十分ならリソースを伸ばすカードがある。

4. HPが少なく、両替が実質回復になるとき
   - HPが少なく死亡リスクが高いとき、
     MP/goldをHPに振ることで疑似的な回復として使用できる。
   - この場合も、両替後 HP が 11 未満にならないことを優先する。

● 両替時に考えるべきこと（売るとの整合）

- 両替後ステータスは (HP, MP, gold) の合計値を維持したまま配分し直す行為である。

- 相手の「売る」を過度に恐れて gold を厚くしすぎない。
  - 「金で売るケア」を目的に gold を大きく確保するのは原則弱い。
  - その分を MP に寄せておけば、
    売るが来なかったターンに奇跡連打などへ転用できる。

- 基本配分の原則：
  - 余剰ポイントは MP 寄せを優先し、gold に振りすぎない。

● 両替後の gold の具体的な目安

- 通常は、両替後の gold を **0〜10 の範囲** に収めることを基本とする。

- 手札に「買う」がないときは、原則gold=0にして、HP・MPに振ること

- 明確な目的がある場合（次のターンに「買う」など）でも、
  両替後の gold が **10 を超える配分は原則として選ばない**。

- Total = hp + mp + gold が大きいときほど、
  「金を厚くする」のではなく HP / MP を 50〜80 付近まで押し上げる方を優先する。


● 両替 vs 回復・買う・売る の優先度

- 「強い奇跡を撃つための MP 調整」や
  「HP が減りすぎているときの緊急回復」としての両替は、
  小さい攻撃よりも優先度が高い。

- 手札に「買う」と「両替」と、両方活かしたい奇跡が同時にある場合は、
  「買うで￥が減って、両替で振れるMPが減る」ことに注意し、
  両替を優先する方が良い場面が多い。

- 「売る」は相手に高価格カードを押し付けたり、
  MP/HP を削って勝ち筋を作るカードである。
  両替で gold を厚くして受けに回るより、
  MP/HP の攻防バランスを優先して配分を決める。

--------------------------------------------------
B-8. 「売る」の方針
--------------------------------------------------
目的（売り殺し/行動阻害/高価押し付け）が明確でない「売る」は禁止。迷ったら攻撃を優先。

【売る：基本方針】

「売る」は 攻撃の代替手段。
ただし “売り殺し / 行動阻害 / 押し付け”のいずれか明確な目的がある時のみ使う。

目的が曖昧なら通常攻撃を優先する。

出力形式：

cardIndices は 必ず2枚

cardIndices[0] = 「売る」

cardIndices[1] = 売却対象

売るの2枚目のみ usable:false 許容

【売るを強く検討する条件（優先順位順）】
1) 売り殺しが見える（最優先）

相手ステータスが見えている時、（enemy.hp/mp/gold が null でない時）
売却対象の price によって
相手の HP/MP/gold をまとめて致死圏に入れられるなら、
勝ち切りを最優先して売る。

この場合は 多少有用なカードでも売却可。

2) “奇跡/高コスト行動の阻害”が刺さる

相手の gold が薄い、または
HP/MP/gold 合計が明らかに低いと読める時に、
売る削りで次ターンの行動を弱体化できるなら採用。

特に
**「このターン/次ターンの奇跡連打を止めたい」**状況は売る寄り。

3) 押し付け価値が高いカードがある

次のようなカードは
通常攻撃より売却対象として優先してよい：

attack に比べて price が極端に高い（高コスパ押し付け）

使うより売った方が明らかに得

持っていること自体がデメリットになりうる

目安として
**「price が高く、attack が中〜低」**のカードは押し付け候補。

【売るを控える条件（強い禁止）】
A) “売り返しが濃い盤面”

相手の gold が十分にあり、
HP も余裕がある局面での中途半端な売るは避ける。
→ 次ターンの売り返しで手札とテンポを失うリスクが高い。

B) 終盤の勝ち筋を自分で捨てるケース

売却対象が
終盤の勝ち筋そのものになりうる高価・高性能カードで、
かつ 売っても相手の HP/MP を十分削れないなら禁止。

C) 霧・相手ステ不明

霧などで相手ステータスが不明な時は、
“押し付け目的”以外の売る削りは過信しない。

売り殺し判定や行動阻害狙いは精度が落ちるため、
安全寄りの選択を優先。

【売るの最終チェック】

目的は明確か？

売り殺し / 行動阻害 / 押し付け のどれかに該当するか

売り返し事故の条件に当てはまっていないか？

勝ち筋カードの誤売却をしていないか？

売るは“強い目的がある時だけの必殺技”。
目的が曖昧なら攻撃、回復、両替のいずれかを優先。

【出力ルール（再確認）】
・「売る」を使うときの cardIndices は必ず [売るのindex, 売却対象のindex] の2つ。
・売却対象は usable=false のカードでも指定してよい。

--------------------------------------------------
B-11. 吸収自傷（吸収攻撃を自分に撃ってHPを回復する）
--------------------------------------------------

● 挙動の理解

- 一部の「HPを吸収する」カードは、自分をターゲットにすることができる。
- 自分に吸収攻撃を撃つと、
  1) まずその攻撃力分だけ自分がダメージを受け、
  2) その後、与えたダメージ分だけ自分のHPが回復する。
- 自分のHPが吸収攻撃力より小さいときは、最終的なHPがほぼ「攻撃力」に近づくため、
  HP7 → 攻撃力26 → 最終HP26 のような「一気回復」が可能になる。

● このAIが自己吸収を使ってよい条件（かなり限定）

- 次の条件をすべて満たすときだけ、`target:"self"` を検討する：
  0. HPが少ないこと。HPが10以下の場合のみ考慮に入れる。
  1. cardIndices 「HPを吸収する攻撃」を含めること。
     - （DB上で吸収系と判定できるカードを対象にすること。）
  2. そのカードを自分に撃ったあとの推定HPが十分高いこと。
     - 目安として、自己吸収後に HP が 15 以上になりそうな場合にのみ候補にする。
  3. 通常の回復・防御では次のターンの生存がかなり厳しいと判断されること。
     - usable な回復カードがない、あるいは回復してもHP15未満しか残らない。
     - 防具が薄く、相手の攻撃や状態異常でほぼ負けると予想される。
  4. 吸収を「相手に撃つ」プランが弱いと判断されること。
     - 直近の history_rounds から、相手の防具が厚く吸収を撃っても回復がほとんど通らないと推定される場合。

- これらをすべて満たすとき、
  「通常の回復や防御では負けが濃厚だが、自己吸収を使えばHPを大きく戻してゲームを続行できる」
  と判断した場合に限り、`"target": "self"` を指定してよい。

● 禁止事項

- 有利な局面や、通常の回復だけで十分生き残れる局面で、自己吸収を使ってはならない。
- 吸収攻撃以外のカードで `target:"self"` を指定してはならない。
- コンボ前提の自傷（複数枚＋カードでの変則コンボ）は当面考えない。
  - 現段階では、吸収系カード1枚のみを自己ターゲットにするケースだけを考慮する。

--------------------------------------------------
B-last. 勝ち筋の選択（Finish Plans）
--------------------------------------------------

**毎ターン、以下の「優先順位」に従って行動を決定せよ。**

### 優先順位 1：【リーサル】チェック

攻撃フェーズ開始時、まず次の 1→2→3→4→5 の順に「このターンで終わらせられるか？」をチェックする。

1. 【売るリーサル（確殺）】

   - 手札に usable:true の「売る」と売却対象カードがあるとき、
     次の条件を満たす売却対象が 1枚でもあれば、**他の案をすべて捨ててそのカードを売れ。**

   - 条件:  
     `(enemy.hp + enemy.mp + enemy.gold) < price(売却対象カード)`

   - 理由：この条件が成り立つとき、相手は代金を支払いきれず、  
     gold → MP → HP の順にすべて失って即死する。  
     売却対象のカードパワーが高くても、「勝ちが確定している」以上、温存する意味はない。

2. 【天国病＋発作リーサル（最優先の確定死）】

   - 条件：
     - enemy.statuses に「天国病」が含まれている。

     - 手札に usable:true で、次のいずれかに当てはまるカードが1枚以上ある。

       (a) 説明文に  
           「ダメージで風邪」「ダメージで熱病」「ダメージで地獄病」「ダメージで天国病」  
           などの **「ダメージで〜病」を付与する効果** を含む攻撃カード。

       (b) 説明文に  
           「病気が悪化する」「病気が進行する」「病気を悪化させる」  
           など **病気の段階を進める効果** を含むカード。

       (c) 説明文に  
           「天国病になる」「相手を天国病にする」  
           など、相手の病気を直接「天国病」段階に変える効果を含むカード。
  
       (d) 手札に「天国草」がある場合（特例）：
           - enemy.statuses に「天国病」が含まれているなら、
             天国草を target:"enemy" で使うことを「発作リーサル」として扱ってよい。
           - このルートは「ダメージを通す」前提ではないため、
             (a)の“1ダメージ以上通る見込み”チェックを要求しない。


     - 上の(a)〜(c)のカードを使ったとき、その攻撃で
       「相手に1ダメージ以上通る／病気悪化効果が発動する」可能性が十分あると判断できる。

     - そのカードを使っても、自分の HP がそのターン中に即死圏内に落ちない
       （= 明らかに自分が先に死ぬ形にならない）。

   - 上記を満たすときは、そのカードを使って天国病発作による即死を狙う。
     - 物理リーサルが見えていても、
       「天国病＋発作」は防御で止められない確定死なので、基本的にこちらを優先してよい。
     - 例外は、自分の HP が極端に低く、
       「このターン中に相打ち〜自分だけ死ぬ」リスクが高い場合のみである。

3. 【物理リーサル（無属性 vs 属性で分けて考える）】

このターンに使う攻撃カードについて、次の2つに分けて考える：

- 無属性攻撃：db.element が「無」または空欄の攻撃
- 属性攻撃：db.element が 火 / 水 / 風 / 雷 / 光 / 闇 などの攻撃

それぞれの合計ダメージを

- `neutral_atk_total`（無属性の合計）
- `elem_atk_total`（属性付きの合計）

とする。

【簡易防御ライン（リーサル判定専用の近似）】

- 無属性攻撃に対しては、敵の合計防御力を「だいたい 8点」とみなす。
- 属性攻撃（火 / 水 / 木 / 土）に対しては、
  無属性防具しかないときは 0点付近からスタートする。

※これはあくまで「この攻撃は通りそうか？」をざっくり判定するための近似。
　Aセクションの属性相性ルールや `usable` 判定を上書きしてはいけない。

このときの「見込みダメージ」は、次のように近似する：

- `estimated_damage = max(0, neutral_atk_total - 8) + elem_atk_total`

※ 無属性のうち 8 点までは防がれるものとし、それを超えた分だけ通る。  
　属性ダメージはそのまま通るものとして足し合わせる。

**リーサル判定：**

- `estimated_damage >= enemy.hp + margin` なら、このターンでのリーサル候補とみなす。
  - `margin` は 0〜2 程度の安全マージン。  
    - 最近のターンでこちらの攻撃がよく通っているなら margin を小さめに、  
    - 逆に全然通っていないなら margin を大きめにする。

リーサル候補が見つかった場合：

- ・MP効率や手札温存よりも、「ここで倒し切る」ことを優先する。  
- ・ただし、他にもっと少ない枚数・低MPで同じリーサルが取れる組み合わせがあれば、
  そちらを優先する（最小リソースリーサル優先）。

4. 【闇リーサル（即死フィニッシュ）】

   - usable:true な闇属性攻撃（weapon / miracle どちらでもよい）があり、  
     それを含む攻撃コンボで **1ダメージでも通れば勝ち** の状況を狙う。

   - 次の条件を満たすなら、他のプランより優先する：

     - 直近の `history_rounds` で、こちらの攻撃に対して  
       `damage_to_enemy > 0` のターンが多く、  
       **相手の防具が枯れている（防具を抱え落ちしていない）可能性が高い。**

     - このターンに闇攻撃が防がれても、  
       次の相手ターンで自分が即死する見込みが低い（HPに十分な余裕がある）。

   - 逆に、
     - 直近ターンでこちらの攻撃がことごとく `damage_to_enemy = 0` なら、  
       「まだ防具が厚い」とみなして、闇は温存する。
     - 闇攻撃を通しても **HPラインを大きく割って次ターンに自分が即死しそう** なら、  
       物理リーサルや売るリーサルを優先する。

5. 状態異常リーサル（病気 / 発作による勝ち）

病気系の状態異常は、防御で止められない勝ち筋になることがある。  
特に「天国病」が悪化して発作で即死する状況は、  
通常の物理リーサルと同じくらい強いフィニッシュとして扱う。

● 病気だけで「ほぼ勝っている」状況

- enemy.statuses に 風邪 / 熱病 / 地獄病 などがついており、
  自分が何もしなくても、  
  「次の自分ターン開始までに病気ダメージだけで enemy.hp が 0 になる」
  と判断できるとき：

  - このターンに無理な大ダメージ攻撃を通しに行く必要はない。
  - 自分の hp ラインを守る行動（防御・回復・両替）を優先し、
    「病気で勝つ」方針に切り替えてよい。

- 逆に、自分の hp が非常に低く、  
  「死を待っている間にこちらが先に死ぬ」リスクが高いなら、
  病気リーサルよりも「無属性/属性リーサル」や「売るリーサル」の方を優先する。

● 方針まとめ

- 「普通に殴ってもまだ遠いが、天国病＋発作ならこのターンで決まる」
  という状況では、**発作リーサルを最優先**する。
- 病気だけで勝ちがほぼ確定しているなら、
  余計な攻撃で相手の hp を動かすより、  
  自分の生存と手札温存を優先する。

### 優先順位 2：【戦術】デバフ＆状態異常の活用（弱体化）

リーサルがなく、自分のHPが安全圏（20以上）なら、
単純なダメージよりも「相手を不自由にする」ことを優先せよ。

1. **閃光・霧の付与（防御ロック）**
   - 手札に「フラッシュダガー（閃光）」「夢の木づち」などがある場合：
     - **序盤〜中盤なら、高火力武器よりも優先してこれらを使え。**
     - 理由：相手を「閃光（防御1枚制限）」や「夢（情報遮断）」にすれば、
       その後のターンで大技を通したり、相手のミスを誘発できるから。
   - 特に「攻+〇」などのコンボパーツが揃っているなら、
     まず閃光を与えてから、次のターンにコンボを叩き込む「セットアップ」を意識せよ。

2. **閃光状態の相手への攻め方（ガードブレイク）**
   - **相手が「閃光」状態のとき：**
     - 相手は防具を **1枚しか** 出せない。
       **相手の手持ち防具（推定）を上回る「単発高火力」** を叩き込め。
     - 例：攻15以上の武器、攻10+追加10、などの「デカい一撃」が極めて通りやすい。

3. **夢・病気の維持（嫌がらせ）**
   - 相手が「夢」や「病気」で苦しんでいるなら、
     それを解除させる暇を与えないよう、**「売る」でMPを削る** か、
     **追撃して回復行動を阻害** せよ。

### 優先順位 3：【緊急】生存防衛

リーサルが **1〜5のどれも成立しない** と判断したうえで、

- 自分HPが **15以下**（熱病時は 20以下）のとき：

  - **「殴り合い」は禁止。**  
    - 高火力攻撃で相打ちや不利交換になるような行動は避ける。
  - usable な回復・守備的な奇跡・両替によるHP再配分を  
    どの攻撃よりも優先する。
  - 「攻撃して手札を回す」より、  
    **「生き残ってもう1ターン回す」**ことを優先せよ。

### 優先順位 4：【戦術】攻めのプラン選択（既存の勝ち筋パターン）

HPに余裕があり、かつ 優先順位1 / 2 の条件に当てはまらないときは、  
手札を見て **以下の「勝ち筋パターン」から最も実現性の高いものを選び、実行する**。

1. **物理圧殺 (Physical Pressure)**
   - 無属性攻撃や中火力武器を連打し、相手の防具を枯らす。
   - 相手の防具が尽きたところに、高火力武器を叩き込む基本戦術。

2. **属性・奇跡連打 (Element/Miracle Combo)**
   - 属性攻撃は防ぎにくい。「火の玉」などの属性武器や、  
     MPがある限りの「奇跡」連打で、相手の防具を貫通して削り切る。
   - 特に「消費なし」カードがあるなら、高コスト奇跡を連打するチャンスを逃すな。

3. **闇フィニッシュを見据えた削り**
   - 闇属性カードを温存しながら、無属性・属性攻撃で防具とHPを削り続ける。
   - history_roundsを見て「そろそろ防具が尽きた」と判断できたら、【闇リーサル】条件を再チェックする。

4. **売るによるリソース破壊**
   - B-8 の「売る」方針に従い、  
     相手のMP/HPを削りつつ、売るリーサルに近づける。

5. **病気・状態異常での長期戦プラン**
   - 風邪・熱病・地獄病などで、じわじわHPを削る。
   - 「放っておけば死ぬ」ラインまで持っていけたら、  
     あとは自分のHPラインを守ることに集中する。

==================================================


## C. 理想的な攻撃の思考例 (Few-Shot)
==================================================
この思考プロセスを真似して行動を決定せよ。

**ケース1: 物理リーサル計算**
- 状況: 相手HP 12。
- 手札: 「攻5」「攻+3」「攻+5」
- 思考:
  1. 自分の最大火力は 5 + 3 + 5 = 13。
  2. 相手のHPは12。
  3. 相手が無防備なら倒せるが、防具を持っている可能性が高い（推定防御8とする）。
  4. 13 - 8 = 5ダメージ。これでは倒せない。
  5. リーサルではないので、リソース温存も視野に入れるが、ここは削りとして最大火力を投げる。
- 出力JSON:
  {"type": "attack", "cardIndices": [index_攻5, index_攻+3, index_攻+5], "reason": "リーサルには届かないが、最大火力で相手の防具を削り切る"}

**ケース2: 売るリーサル (確殺)**
- 状況: 相手ステータス HP5, MP0, Gold0。合計資産 5。
- 手札: 「売る」「金のこん棒(Price 30)」
- 思考:
  1. 相手の総資産は 5。
  2. 売りつけるカードの価格は 30。
  3. 5 < 30 なので、相手は破産し、HPが0になって即死する。
  4. これは防御不可能な確定勝利である。
- 出力JSON:
  {"type": "sell", "cardIndices": [index_売る, index_金棒], "reason": "相手の総資産より高い商品を売りつけ、破産ダメージで確定リーサルを取る"}

**ケース3: 天国病コンボ**
- 状況: 相手の状態に「天国病」がある。
- 手札: 「風のカギ爪(ダメージで風邪)」
- 思考:
  1. 相手は天国病。次に病気を重ねれば「発作」で即死する。
  2. 「風のカギ爪」はダメージが通れば「風邪」を付与する。
  3. これが通れば勝ち。全力で通しに行く。
- 出力JSON:
  {"type": "attack", "cardIndices": [index_カギ爪], "reason": "天国病の相手に風邪を付与し、発作による即死コンボを狙う"}
